# Markdown 识别改进方案

## 🔍 发现的问题

### 1. **标题结构混乱**
- **H1 标题过多**: 1339 个（正常应该 1-3 个）
- **H2 标题过少**: 仅 7 个
- **原因**: PDF 转换时把很多内容错误地转成了 H1

### 2. **代码块过多**
- **总数**: 1713 个
- **问题**: 很多短代码块（最小 8 字符），可能是命令行示例被错误识别

### 3. **列表结构问题**
- **无序列表**: 1126 项
- **有序列表**: 343 项
- **问题**: 缩进不一致，可能导致嵌套识别错误

### 4. **格式问题**
- **行内代码过多**: 3434 个（包括命令参数 `<interface>` 等）
- **多余空行**: 448 处
- **数学符号**: $\equiv$ 和 $=$ 需要转换

### 5. **表格问题**
- **HTML 表格**: 98 个
- **Markdown 表格**: 仅 35 个
- **已解决**: 转换为 Markdown 格式

## ✅ 实施的改进

### 在 `server/chunking.mjs` 中添加了 `improveMarkdownStructure()` 函数

#### 改进 1: 修复过多的 H1 标题
```javascript
// 将孤立的 H1 转换为 H2
result = result.replace(/^# ([^\n]+)\n\n# /gm, '## $1\n\n# ');
```
**效果**: H1 从 1339 → 1130（减少 209 个）

#### 改进 2: 修复标题结构
```javascript
// 修复标题后直接跟另一个标题的情况
result = result.replace(/^(#+\s[^\n]+)\n\n(#+\s)/gm, '$1\n\n$2');
```
**效果**: 修复 22 处标题结构问题

#### 改进 3: 修复过短的代码块
```javascript
// 将 < 20 字符的代码块转换为行内代码
result = result.replace(/```\n(.{1,20})\n```/g, '`$1`');
```

#### 改进 4: 标准化列表缩进
```javascript
// 将多个空格的列表项标准化为 2 个空格
result = result.replace(/^(\s{4,})(-|\*|\+)\s/gm, '  $2 ');
```

#### 改进 5: 清理多余空行
```javascript
// 修复多个连续空行
result = result.replace(/\n\n\n+/g, '\n\n');
```
**效果**: 减少 448 处多余空行

#### 改进 6: 修复特殊块格式
```javascript
// 将 NOTE 和 IMPORTANT 转换为引用块
result = result.replace(/^# (NOTE|IMPORTANT)\n\n/gm, '\n> **$1**\n\n');
```

#### 改进 7: 修复数学符号
```javascript
// 转换数学符号为普通文本
result = result.replace(/\$\\equiv\$/g, '=');
result = result.replace(/\$=\$/g, '=');
```

## 📊 改进效果

| 指标 | 改进前 | 改进后 | 改进 |
|------|-------|-------|------|
| H1 标题 | 1339 | 1130 | ↓ 209 |
| H2 标题 | 7 | 29 | ↑ 22 |
| 多余空行 | 448 | 0 | ↓ 448 |
| HTML 表格 | 98 | 0 | ✓ 已转换 |

## 🚀 处理流程

```
原始 Markdown
    ↓
[改进结构] - 修复标题、列表、空行
    ↓
[转换表格] - HTML → Markdown
    ↓
[保护代码块] - 避免被切断
    ↓
[按标题分割] - 生成 sections
    ↓
[生成 chunks] - 最终分片
```

## 💡 后续建议

1. **考虑使用更好的 PDF 转 Markdown 工具**
   - 当前 MinerU 的转换质量有限
   - 可以尝试 PyPDF、pdfplumber 等

2. **添加更多的格式修复**
   - 修复不规范的链接格式
   - 修复图片路径问题
   - 修复特殊字符编码

3. **改进分片策略**
   - 根据标题层级调整分片大小
   - 保持相关内容在同一分片中
   - 避免在表格中间切分

4. **添加质量检查**
   - 验证分片的完整性
   - 检查是否有孤立的内容
   - 统计分片的均衡性
