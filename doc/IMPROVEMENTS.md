# AI知识助手改进方案

## 问题分析

用户反馈系统存在以下问题：
1. **AI幻觉** - AI编造了文档中不存在的命令
2. **精度不准确** - 回答包含不相关的信息
3. **命令行错误** - 提供的命令格式或参数不正确

## 根本原因

1. **检索相关性阈值过低** - minScore设置为0.2-0.35，导致低相关性文档被返回
2. **提示词不够严格** - 虽然有防止幻觉的指令，但AI仍可能"创意性"地补充信息
3. **缺少命令验证机制** - 没有对生成的命令进行格式验证

## 实施的改进

### 1. 加强提示词（src/lib/chinesePrompts.ts）

#### 修改内容：
- **WITH_REFERENCES_STRICT**: 添加了第6条规则"命令行必须逐字引用"
  - 禁止修改、简化、扩展或创建任何命令
  - 如果参考内容中没有完整的命令，必须明确说明

- **NETWORK_CONFIG_STRICT**: 添加了第7条规则"禁止命令创意"
  - 绝对禁止根据逻辑推理创建或修改命令
  - 每个命令必须标注来源文档

- **ANTI_HALLUCINATION**: 扩展了禁止行为列表
  - 禁止修改、简化或扩展参考内容中的命令
  - 禁止根据逻辑推理添加参考内容中没有的参数
  - 禁止提供参考内容中没有的替代命令或方案
  - 禁止补充参考内容中缺失的步骤

#### 效果：
- 更明确地指导AI不要编造命令
- 强制AI标注命令来源
- 明确说明缺失信息

### 2. 添加命令验证机制（src/lib/chinesePrompts.ts）

#### 新增函数：`validateCommandsInAnswer()`
```typescript
export function validateCommandsInAnswer(answer: string, references: string[]): {
  isValid: boolean;
  warnings: string[];
  suspiciousCommands: string[];
}
```

#### 功能：
- 提取答案中的代码块和命令行
- 检查每个命令是否在参考内容中存在
- 返回可疑命令列表和警告信息

#### 使用场景：
- 可在前端显示警告信息
- 可在后端过滤不可信的命令
- 帮助用户识别可能编造的命令

### 3. 提高检索相关性阈值

#### 修改1：calculateAdaptiveThreshold()（src/lib/retrievalEnhancements.ts）
```typescript
// 原来：Math.min(maxScore * 0.7, avgScore * 1.2)
// 改为：Math.min(maxScore * 0.85, avgScore * 1.5)
```
- 提高了最高分数的乘数从0.7到0.85
- 提高了平均分数的乘数从1.2到1.5
- 结果：只返回高度相关的文档

#### 修改2：getRetrievalParams()（src/lib/advancedIntentDetector.ts）
```typescript
// 原来的minScore范围：0.2-0.35
// 改为的minScore范围：0.45-0.55

baseParams.minScore: 0.5  // 从0.3提高到0.5

// 各意图的阈值：
command: 0.45           // 从0.25提高
troubleshoot: 0.48      // 从0.2提高
configuration: 0.50     // 从0.28提高
explanation: 0.55       // 从0.35提高
comparison: 0.50        // 从0.3提高
performance: 0.50       // 从0.3提高
best_practice: 0.52     // 从0.32提高
verification: 0.48      // 从0.25提高
question: 0.55          // 从0.35提高
general: 0.55           // 从0.35提高
```

#### 效果：
- 只返回高相关性的文档块
- 减少不相关信息的干扰
- 降低AI编造信息的可能性

## 改进效果预期

### 短期效果（立即生效）
1. ✅ AI不再编造命令 - 提示词更严格
2. ✅ 回答精度提高 - 检索阈值更高
3. ✅ 命令格式正确 - 强制逐字引用

### 中期效果（需要测试验证）
1. 用户能识别可疑命令 - 通过验证机制
2. 系统更可靠 - 减少幻觉
3. 用户信任度提高 - 准确性改善

## 测试建议

### 1. 测试命令准确性
```
问题：如何配置BGP？
预期：只返回文档中存在的命令
不应该：编造新的命令或参数
```

### 2. 测试相关性
```
问题：什么是PFC？
预期：只返回高相关性的文档块
不应该：返回不相关的网络配置信息
```

### 3. 测试缺失信息处理
```
问题：如何配置不存在的功能？
预期：明确说明"参考文档中未找到相关信息"
不应该：编造配置步骤
```

## 文件修改清单

| 文件 | 修改内容 | 影响 |
|------|--------|------|
| src/lib/chinesePrompts.ts | 加强提示词，添加验证函数 | 直接影响AI生成质量 |
| src/lib/retrievalEnhancements.ts | 提高自适应阈值 | 影响检索结果相关性 |
| src/lib/advancedIntentDetector.ts | 提高minScore | 影响文档过滤严格度 |

## 后续优化方向

1. **动态阈值调整** - 根据用户反馈动态调整阈值
2. **命令验证集成** - 将验证机制集成到前端显示
3. **用户反馈循环** - 收集用户对命令准确性的反馈
4. **文档质量评估** - 定期评估文档块的质量
5. **A/B测试** - 对比改进前后的效果

## 注意事项

- 提高阈值可能导致某些查询返回结果较少
- 如果用户反馈"找不到相关信息"增加，可适度降低阈值
- 建议监控系统日志中的"参考文档中未找到相关信息"的频率
